R"HTML(
<script>
// ========================
// === FUNCIONES ÚTILES ===
// ========================

// Cambia texto en el DOM de forma segura
function setText(id, txt) {
  const el = document.getElementById(id);
  if (el) el.textContent = txt;
}

// ========================
// === MANEJO DE CSV ======
// ========================
let csvData = [['Tiempo','AHT10 Interno','AHT10 Externo','DHT11 Interno','DHT11 Externo','MLX Obj','MLX Amb','Δt (ms)']];
let lastTs = null;
let lastCsvTime = '';
// Agrega una nueva fila al CSV
function csvPush(d) {

  if (!d || !d.tiempo || d.tiempo === lastCsvTime) return;
  lastCsvTime = d.tiempo;
  const ts = Number(d.ts ?? d.uptime_ms);
  let dt = '';
  if (Number.isFinite(ts)) {
    if (lastTs != null) dt = ts - lastTs; // Diferencia real entre lecturas (ms)
    lastTs = ts;
  }
  csvData.push([
    d.tiempo || '',
    d.ahtTemp1, d.ahtTemp2,
    d.dhtTemp2, d.dhtTemp1,
    d.mlxTempObj, d.mlxTempAmb,
    dt
  ]);
}

// Exporta el CSV como archivo descargable
function exportCSV() {
  const rows = csvData.map(r => r.join(',')).join('\n');
  const blob = new Blob([rows], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Heat_Transfer.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// ========================
// === CONTROL DE RELÉ ====
// ========================
function toggleRelay() {
  fetch('/toggleRelay').then(() => updateSensorData());
}

// ========================
// === FORMULARIOS ========
// ========================
function bindForms() {
  // Límite de temperatura normal
  const f1 = document.getElementById('setLimitForm');
  if (f1) f1.addEventListener('submit', e => {
    e.preventDefault();
    const v = parseFloat(document.getElementById('setLimitInput').value);
    if (isNaN(v) || v < 0 || v > 90) {
      setText('tempLimitMessage', 'El valor debe estar entre 0 y 90°C.');
      return;
    }
    fetch('/setlimit/?temp=' + v.toFixed(2)).then(() => {
      setText('tempLimitMessage', '');
      setText('tempLimitDisplay', v.toFixed(2) + '°C');
      updateSensorData();
    });
  });

  // Límite crítico
  const f2 = document.getElementById('setCriticalLimitForm');
  if (f2) f2.addEventListener('submit', e => {
    e.preventDefault();
    const v = parseFloat(document.getElementById('setCriticalLimitInput').value);
    if (isNaN(v) || v < 0 || v > 45) {
      setText('criticalTempLimitMessage', 'El valor debe estar entre 0 y 45°C.');
      return;
    }
    fetch('/setcriticallimit/?temp=' + v.toFixed(2)).then(() => {
      setText('criticalTempLimitMessage', '');
      setText('criticalTempLimitDisplay', v.toFixed(2) + '°C');
      updateSensorData();
    });
  });
}

// ========================
// === DATOS Y ACTUALIZO ==
// ========================

// Intervalo seguro por defecto (por si UPDATE_MS no viene definido)
window.UPDATE_MS = Number(window.UPDATE_MS) > 0 ? Number(window.UPDATE_MS) : 1000;
window.intervalId = null;

// Actualiza los datos de sensores
function updateSensorData() {
  fetch('/sensordata', {cache: 'no-store'})
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(d => {
      // Actualización del DOM
      setText('ahtTemp1', d.ahtTemp1 + '°C'); setText('ahtHum1', d.ahtHum1 + '%');
      setText('ahtTemp2', d.ahtTemp2 + '°C'); setText('ahtHum2', d.ahtHum2 + '%');
      setText('dhtTemp1', d.dhtTemp1 + '°C'); setText('dhtHum1', d.dhtHum1 + '%');
      setText('dhtTemp2', d.dhtTemp2 + '°C'); setText('dhtHum2', d.dhtHum2 + '%');
      setText('mlxTempObj', d.mlxTempObj + '°C'); setText('mlxTempAmb', d.mlxTempAmb + '°C');
      setText('relayMessage', d.relayMessage);
      setText('relayButton', d.relayState ? 'Apagar Relé' : 'Encender Relé');

      // Guardar datos en CSV
      csvPush(d);

      // Ajuste dinámico de intervalo (si el servidor lo cambia)
      const newMs = Number(d.updateMs);
      if (Number.isFinite(newMs) && newMs > 0 && newMs !== window.UPDATE_MS) {
        window.UPDATE_MS = newMs;
        if (window.intervalId) clearTimeout(window.intervalId);
      }

      // Reprogramar actualización segura (evita solapamientos)
      window.intervalId = setTimeout(updateSensorData, window.UPDATE_MS);

      // Gráfica opcional
      if (window.chartUpdate) window.chartUpdate(d);
    })
    .catch(() => {
      console.warn("Error al actualizar datos del servidor");
      window.intervalId = setTimeout(updateSensorData, window.UPDATE_MS);
    });
}

// ========================
// === INICIALIZACIÓN =====
// ========================
document.addEventListener('DOMContentLoaded', () => {
  bindForms();
  updateSensorData(); // arranca la actualización
});
</script>

</body>
</html>
)HTML";